receivers:
  # ── OTLP (services emit traces/metrics/logs here) ─────────────────────────
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # ── Prometheus scrape (pull existing /metrics endpoints) ──────────────────
  prometheus:
    config:
      scrape_configs:
        - job_name: orchestrator-otel
          scrape_interval: 15s
          static_configs:
            - targets: [orchestrator:8000]
        - job_name: hitl-otel
          scrape_interval: 15s
          static_configs:
            - targets: [hitl:8007]
        - job_name: groupchat-otel
          scrape_interval: 15s
          static_configs:
            - targets: [groupchat:8002]

processors:
  # Batch before export to reduce overhead
  batch:
    timeout: 5s
    send_batch_size: 1024

  # Add resource attributes to all signals
  resource:
    attributes:
      - key: deployment.environment
        value: "local"
        action: insert
      - key: service.namespace
        value: "ai-factory"
        action: insert

  # Memory-limit the collector to avoid OOM
  memory_limiter:
    check_interval: 5s
    limit_mib: 512
    spike_limit_mib: 128

exporters:
  # ── Traces → Jaeger-compatible (or OTLP backend) ──────────────────────────
  otlp/jaeger:
    endpoint: jaeger:4317
    tls:
      insecure: true

  # ── Metrics → Prometheus (pull) ───────────────────────────────────────────
  prometheus:
    endpoint: 0.0.0.0:8889
    namespace: ai_factory_otel

  # ── Logs → Loki ───────────────────────────────────────────────────────────
  loki:
    endpoint: http://loki:3100/loki/api/v1/push
    default_labels_enabled:
      exporter: false
      job: true
    labels:
      resource:
        service.name: "service"
        service.namespace: "namespace"
        deployment.environment: "env"
      record:
        level: "severity"

  # ── Debug (stdout) ────────────────────────────────────────────────────────
  debug:
    verbosity: normal

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [otlp/jaeger, debug]

    metrics:
      receivers: [otlp, prometheus]
      processors: [memory_limiter, resource, batch]
      exporters: [prometheus, debug]

    logs:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [loki, debug]

  extensions: []
